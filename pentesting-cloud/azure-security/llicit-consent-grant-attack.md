# llicit Consent Grant Attack

## **What is Illicit Consent Grant Attack?**

In an illicit consent grant attack, the attacker creates an Azure-registered application that requests access to data such as contact information, email, or documents. The attacker then tricks an end user into granting consent to the application so that the attacker can gain access to the data that the target user has access to. After the application has been granted consent, it has user account-level access to the data without the need for an organizational account.

In simple words when the victim clicks on that beautiful blue button of "Accept", Azure AD sends a token to the third party site which belongs to an attacker where attacker will use the token to perform actions on behalf the victims like accessing all the Files, Read Mails, Send Mails etc.

## **Attack Flow**

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

To perform this attack against the company "ecorp" the attacker could registered a domain with name "safedomainlogin.com" and created a subdomain ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) where they **hosted the application to capture the authorization code** and then request for the access tokens.

Then, register a Multi Tenant Application in their Azure AD Tenant and named it as "ecorp" and added the Redirect URL that points to the "ecorp.safedomainlogin.com" which host's an application to capture the authorization code.

The attacker also create a new client secret and added few API **permissions** such `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` in the application. So that once the **user grant the consent to the application**, the attacker can **extract** the **sensitive information** on behalf of the user.

The attacker finally creates the **link** that contained the client id of the malicious application and **shared** the link with the **targeted users** to gain their consent.

## 365-Stealer

You can perform this attack with [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

As extra step, if you have some **access over a user in the victim organisation**, you can check if the policy will allow him to **accept to apps**:

```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```

Check [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) to learn how to configure it.

## Post-Exploitation

Once you got access to the user you can do things such as stealing sensitive documents and even uploading backdoored document files.

## References

* This post was copied from [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
