# GCP - Network Docker Escape

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Initial State

In both writeups where this technique is specified, the attackers managed to get **root** access inside a **Docker** container managed by GCP with access to the host network (and the capabilities **`CAP_NET_ADMIN`** and **`CAP_NET_RAW`**).

## Attack

When you inspect network traffic on a regular Google Compute Engine instance you will see a lot of **plain HTTP requests** being directed to the **metadata** instance on **`169.254.169.254`**. One service that makes such requests is the open-sourced [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent). Request example:

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

This agent **monitors the metadata for changes.** Inside the **metadata** there is a **field** with authorized **SSH public** keys.\
Therefore, when a new public SSH key appears in the metadata, the agent will **authorize** it in the user‚Äôs `.authorized_key` file and it will **create** a new user if necessary and adding it to **sudoers**.

The way the Google Guest Agent monitors for changes is through a call to **retrieve all metadata values recursively** (`GET /computeMetadata/v1/?recursive=true`), indicating to the metadata server to **only send a response when there is any change** with respect to the last retrieved metadata values, identified by its Etag (`wait_for_change=true&last_etag=`).

This request also includes a **timeout** (`timeout_sec=`), so if a **change does not** occur within the specified amount of time, the metadata server responds with the **unchanged values**.

This makes the **IMDS** to **respond** after **60** **seconds** if there was no configuration change in that interval, allowing a **window for injecting a fake configuration** response to the guest agent from the IMDS.

Therefore, if an attacker manages to perform a **MitM** attack, he could **spoof** the **response** from the **IMDS** server **inserting a new public key** to allow a new user to access via **SSH** to the host.

### Escape

ARP spoofing does not work on Google Compute Engine networks, however, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) generated this **modified version of** [**rshijack**](https://github.com/ezequielpereira/rshijack) \*\*\*\* that can be used to inject a packet in the communication to inject the SSH user.

This modified version of rshijack allows to **pass the ACK and SEQ numbers as command-line** arguments, saving time and allowing us to **spoof a response** before the real Metadata response came.\
\
Moreover, **this** [**small Shell script**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) \*\*\*\* that would return a **specially crafted payload** that would trigger the Google Guest Agent to **create the user `wouter`,** with our own public key in its `.authorized_keys` file.\
\
This script receives the ETag as a parameter, since by keeping the same ETag, the Metadata server wouldn‚Äôt immediately tell the Google Guest Agent that the metadata values were different on the next response, instead waiting the specified amount of seconds in timeout\_sec.\
\
To achieve the spoofing, you should **watch requests to the Metadata** server with **tcpdump: `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** waiting for a line that looked like this:

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

We you see that value send the **fake metadata data with the correct ETAG to `rshijack`**:

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

And this should make the agent **authorize that public key** that will allow you to **connect** via **SSH** with the **private** key.

## References

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
