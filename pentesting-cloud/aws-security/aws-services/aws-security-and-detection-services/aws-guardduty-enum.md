# AWS - GuardDuty Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

**Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

**Share your hacking tricks submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

</details>

## GuardDuty

Amazon GuardDuty is a regional-based intelligent **threat detection service**, the first of its kind offered by AWS, which allows users to **monitor** their **AWS account** for **unusual and unexpected behavior by analyzing VPC Flow Logs, AWS CloudTrail management event logs, CloudTrail S3 data event logs, and DNS logs**. It uses **threat intelligence feeds**, such as lists of **malicious IP** addresses and **domains**, and **machine learning** to identify **unexpected and potentially unauthorized and malicious activity** within your AWS environment. This can include issues like escalations of privileges, uses of exposed credentials, or communication with malicious IP addresses, or domains.

Alerts **appear in the GuardDuty console (90 days)** and CloudWatch Events.

For example, GuardDuty can detect compromised **EC2 instances serving malware or mining** bitcoin. It also monitors AWS account **access behavior for signs of compromise**, such as unauthorized infrastructure deployments, like instances deployed in a **Region that has never been used**, or **unusual API calls**, like a password policy change to reduce password strength.\
You can **upload list of whitelisted and blacklisted IP addresses** so GuardDuty takes that info into account.

Finding summary:

* Finding type
* Severity: 7-8.9High, 4-6.9Medium, 01-3.9Low
* Region
* Account ID
* Resource ID
* Time of detection
* Which threat list was used

The body has this information:

* Resource affected
* Action
* Actor: Ip address, port and domain
* Additional Information

You can **invite other accounts** to a different AWS GuardDuty account so **every account is monitored from the same GuardDuty**. The master account must invite the member accounts and then the representative of the member account must accept the invitation.\
There are different IAM Role permissions to allow GuardDuty to get the information and to allow a user to u**pload IPs whitelisted and blacklisted**.\
GuarDuty uses a service-linked role called "AWSServiceRoleForAmazonGuardDuty" that allows it to retrieve metadata from affected endpoints.

You pay for the processing of your log files, per 1 million events per months from CloudTrail and per GB of analysed logs from VPC Flow

When a user **disable GuardDuty**, it will stop monitoring your AWS environment and it won't generate any new findings at all, and the **existing findings will be lost**.\
If you just stop it, the existing findings will remain.

## Actions

### Enumeration

```bash
aws guardduty list-organization-admin-accounts
aws guardduty list-invitations
aws guardduty get-invitations-count
aws guardduty list-detectors
aws guardduty describe-organization-configuration --detector-id <id>
aws guardduty get-detector --detector-id <id>
aws guardduty list-filters --detector-id <id>
aws guardduty get-filter --detector-id <id> --filter-name
aws guardduty list-findings --detector-id <id>
aws guardduty get-findings --detector-id <id> --finding-ids <id>
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>
aws guardduty list-ip-sets --detector-id <id>
aws guardduty list-members --detector-id <id>
aws guardduty list-publishing-destinations --detector-id <id>
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty list-ip-sets
aws guardduty get-ip-set --detector-id <id>
aws guardduty get-master-account --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```

## Avoid Detection

### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

With those permissions you could disable GuardDuty to avoid triggering alerts.

```bash
# Disabling the detector
aws guardduty update-detector \
    --detector-id 12abc34d567e8fa901bc2d34eexample \
    --no-enable 

# Removing s3 as a log source
aws guardduty update-detector \
    --detector-id 12abc34d567e8fa901bc2d34eexample \
    --data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
    --detector-id 12abc34d567e8fa901bc2d34eexample \
    --finding-publishing-frequency SIX_HOURS
```

### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

An attacker could create or update GuardDuty's [Trusted IP list](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html), including **their own IP on the list**. Any IPs in a trusted IP list will **not have any Cloudtrail or VPC flow log alerts raised** against them.

{% hint style="info" %}
DNS findings are exempt from the Trusted IP list.
{% endhint %}

```
aws guardduty update-ip-set \
    --detector-id 12abc34d567e8fa901bc2d34eexample \
    --ip-set-id 24adjigdk34290840348exampleiplist \
    --location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
    --activate
```

{% hint style="info" %}
Depending on the level of stealth required, the **file can be uploaded to an s3 bucket in the target account, or an account controlled by the attacker.**
{% endhint %}

### `guardduty:CreateFilter`

Newly create GuardDuty findings can be automatically archived via [Suppression Rules](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html). An adversary could **use** [**filters**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html) **to automatically archive findings** they are likely to generate.

Filters can be created using the [CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html).

```
aws  guardduty create-filter --action ARCHIVE --detector-id 12abc34d567e8fa901bc2d34e56789f0 --name yourfiltername --finding-criteria file://criteria.json
```

### `guardduty:DeletePublishingDestination`

An adversary could disable alerting simply by [deleting the destination](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) of alerts.

```
aws guardduty delete-publishing-destination --detector-id abc123 --destination-id def456
```

### Pentest Findings

When making AWS API requests on common penetration testing OS's GuardDuty will detect this and trigger a [PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
This is caused by the **user agent name** that is passed in the API request. By **modifying that** we can prevent GuardDuty from detecting that we are operating from a "pentest" Linux distribution.

{% hint style="warning" %}
If your assessment requires you to remain undetected it's probably easier to leverage a "safe" OS like Ubuntu, Mac OS, or Windows.
{% endhint %}

To do this, identify the location of your `session.py` in the `botocore` package. For example, on a default Kali Linux install it can be found at `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

On line [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456) (at the time of writing), you should see the following.

![](<../../../../.gitbook/assets/image (52).png>)

`platform.system()` and `platform.release()` are similar to `uname -o` and `uname -r`. On a stock Kali install it will generate the following values.

To get around this, **modify the code and replace it with legitimate user agent strings like those found in** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt). With this capability you can mask your user agent to look like anything you want. Even arbitrary values like below.

![](<../../../../.gitbook/assets/image (43).png>)

### Tor Client Findings

[UnauthorizedAccess:EC2/TorClient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient) is a high severity GuardDuty finding that fires when an EC2 instance is detected making connections to Tor [Guard](https://community.torproject.org/relay/types-of-relays/#Guard%20and%20middle%20relay) or Authority nodes.&#x20;

AWS determines this by comparing connections to the [public list of Tor nodes](https://metrics.torproject.org/exonerator.html). The [Tor Project](https://www.torproject.org/) has largely gotten around this by using [Bridges](https://community.torproject.org/relay/types-of-relays/#Bridge). Bridges are special nodes that do not disclose themselves like other Tor nodes do. Individuals who would normally have difficulty connecting directly to Tor can instead route their traffic through Bridge nodes. Similarly, we can **bypass the Tor Client GuardDuty finding by using bridges**.

To do so, download the Tor and obfs4proxy binaries (the simplest way to do this on a Debian based system is `apt install tor obfs4proxy` and move them to your target). [Obfs4](https://gitlab.com/yawning/obfs4) is a [Pluggable Transport](https://2019.www.torproject.org/docs/pluggable-transports.html.en) which modifies Tor traffic to communicate with a bridge. Navigate to [bridges.torproject.org](https://bridges.torproject.org/options) to get a bridge address.

From here, create a torrc file with the following contents (being sure to fill in the information you got for the bridge address):

```
UseBridges 1
Bridge obfs4 *ip address*:*port* *fingerprint* cert=*cert string* iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```

You will now be able to connect to the Tor network with `tor -f torrc` and you can connect to the Socks5 proxy on port 9050 (by default).

### Credential Exfiltration Detection

If you **steals EC2 creds** from the metadata service and uses them **outside AWS infrastructure** the alert [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) is triggered.

Moreover, if you **use your own EC2 instance** to use the **stolen credentials** the alert [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) is triggered.

However, there is currently a functioning bypass for this - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). Using **VPC Endpoints** will **not trigger the GuardDuty alert**. What this means is that, as an attacker, `if you steal IAM credentials from an EC2 instance, you can use those credentials from your own EC2 instance while routing traffic through VPC Endpoints. This will not trigger the GuardDuty finding`.

To make this setup faster (and easier) for Penetration Testers and Red Teamers, [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) **was created**. This project has all the Terraform configurations necessary to **spin up an environment to attack from**. It will create an EC2 instance in a private subnet (no internet access) and create a number of VPC Endpoints for you to use. This setup ensures we don't accidentally expose ourselves and trigger the alert.

{% hint style="info" %}
There is another bypass option. The InstanceCredentialExfiltration finding is only tied to the AWS account, not the EC2 instance. As a result, if you **compromise an EC2 instance in the target account** and then compromise **OTHER EC2 instances in the account**, or steal their IAM credentials, you can **safely use them from the initially compromised** instance without fear of triggering GuardDuty.
{% endhint %}

## References

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

**Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

**Share your hacking tricks submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

</details>
