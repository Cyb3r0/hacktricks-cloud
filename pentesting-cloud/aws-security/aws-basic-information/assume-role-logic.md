# Assume Role Logic

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Assume Role Logic

To allow an entity to temporarily elevate their access to a different role, AWS provides the [AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html) action in STS. This returns an access key ID, secret key, and a session token for the specified ARN.

As a Penetration Tester or Red Teamer, **Assume Role can be an excellent vector to escalate privileges** or move to other AWS accounts in the organization. It is worth noting however that the logic/requirements to perform Assume Role differ if you are assuming a role in the same account versus assuming a role in a different account.

### Same Account <a href="#same-account" id="same-account"></a>

In order to assume a role, there are typically two requirements:

1\) The **target role has a trust relationship with the entity attempting** to assume the role\
2\) The role attempting to perform the assumption **has the** [**sts:AssumeRole**](https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html) **privilege**.

When attempting to assume a role **in the same account**, these requirements are slightly **relaxed**.

When assuming a role in the same account, the trust relationship for the target role may be tied to a specific role (via an ARN). In this situation that role does NOT need to have AssumeRole privilege. If, however, the trust relationship is tied to the ARN of the account itself that role DOES need to have AssumeRole privilege.

Here is an example of each situation.

#### Trust Relationship with Account <a href="#trust-relationship-with-account" id="trust-relationship-with-account"></a>

You DO need AssumeRole privilege on the base role.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {}
    }
  ]
}
```

#### Trust Relationship with Role <a href="#trust-relationship-with-role" id="trust-relationship-with-role"></a>

You DO NOT need AssumeRole privilege on the base role. Do note: having that privilege does not hinder you in any way.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/specific-role"
      },
      "Action": "sts:AssumeRole",
      "Condition": {}
    }
  ]
}
```

#### Advice for Same Account <a href="#advice-for-same-account" id="advice-for-same-account"></a>

When looking for privilege escalation vectors in an AWS account, first look for roles that explicitly define a role ARN in their Trust Relationship and paths to get there. The relaxed requirement around having AssumeRole privileges helps because you are only reliant on the trust relationship, not additional privileges. Additionally, because of the different requirements between same and cross account role assumption, some administrators may be under the impression the base role requires AssumeRole privileges and as such may not be aware of the security considerations around this.

### Cross Account <a href="#cross-account" id="cross-account"></a>

When assuming a role across accounts the base role must have AssumeRole privileges, regardless of if the Trust Relationship specifies an account or a specific role.

## Confused Deputy Problem

If you **allow an external account (A)** to access a **role** in your account, you will probably have **0 visibility** on **who can exactly access that external account**. This is a problem, because if another external account (B) can access the external account (A) it's possible that **B will also be able to access your account**.

Therefore, when allowing an external account to access a role in your account it's possible to specify an `ExternalId`. This is a "secret" string that the external account (A) **need to specify** in order to **assume the role in your organization**. As the **external account B won't know this string**, even if he has access over A he **won't be able to access your role**.

<figure><img src="../../../.gitbook/assets/image (1) (7).png" alt=""><figcaption></figcaption></figure>

However, note that this `ExternalId` "secret" is **not a secret**, anyone that can **read the IAM assume role policy will be able to see it**. But as long as the external account A knows it, but the external account **B doesn't know it**, it **prevents B abusing A to access your role**.

Example:

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Principal": {
      "AWS": "Example Corp's AWS Account ID"
    },
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringEquals": {
        "sts:ExternalId": "12345"
      }
    }
  }
}
```

## References

* [https://hackingthe.cloud/aws/general-knowledge/assume\_role\_logic/](https://hackingthe.cloud/aws/general-knowledge/assume\_role\_logic/)
* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
